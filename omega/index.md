Title: TWE-liteで簡単無線通信
Subtitle: TWE-liteモジュールで作るラジコン艦隊これくしょん(物理)
Author: @omegamega
Author(romaji): おめが

<!--
編集上、この上の行はこのまま残しておいてね
本番のファイルは index.md で作ってね
-->

# TWE-liteモジュールで作るラジコン艦隊これくしょん(物理)


# 提督が工廠に着任しました

## あらすじ

ある日の仲間内チャット
「ActionStations!　いやー、World of Warshipsは面白いなー。」

「そういえば、自分の水田に自作の軍艦モデルを浮かべてるやつは話題になったよなー」
「あれは良かったよね。動画で見ると、すごい様になってた」

広島の農家の方が、休耕田を使ってスチロール製の自作軍艦モデルを浮かべていた話。
自作というだけあって、1m以上のサイズ。動力はなくてあくまで風で流されるだけのよう

「ティンときた！ヘイテイトクー、あんな感じで動力つけて、軍艦モデルを実際に走らせたり、後々は自動操縦とかしたら面白そうだよね？」
「面白い(確信)」
「艦これで遠征に出すと、連動して動くと面白そう」
「空飛ぶドローンは何かと世間を騒がせて、今後いろいろと厳しくなりそうだし、僕らは安全に水上ドローンを作る」
「なるほどな」

「しかし、軍艦モデルのサイズはめちゃくちゃ小さいよ？どう仕込むの？
一から大きめの船体作ってモーターライズしている人たちいるし、そっちを見習って作るのがいいんじゃない？」

調べてみるとかなり大型のモデルでモーターライズをしている方々はいるよう。
とはいえ、既存のキットでもない限り60～80cmぐらいの寸法でも直進のみの、リモコンなしが多いようだ。この辺はスケールモデラーの方々がやっている模様。

「さすがに軍艦モデルを作るのは手間がかかりすぎるし、やりたくないなー。とはいう船体に仕込めるサイズだと1mぐらいの長さになっちゃうでしょ。
できれば市販の軍艦モデルをそのまま使って走らせたい。市販のやつなら艦のバリエーションも出せるし」
「かといって一番数がある1/700は小さいよ。マブチ/田宮の水中モーターみたいにぶら下げるとかならまだしも…　でもあれはラジコンじゃないしな」

この辺に図

「いっそ、船体を縦に伸ばしてそこにラジコン機構を積もう」
「縦に？」

この船は伸びる、縦に。この辺に図

「水中部分がデカい分には目立たないんじゃない？水面下なんだし」
「なるほど？」
「それなら、別に水中だけ幅広のでっかいボディでもいいんじゃない？水中モーターみたく、適当な軍艦モデルにペタリと後付できるとモジュラリティ高くできるよ」
「アルペジオのタカオが潜水艦吊るしてたみたいな感じか？コバンザメみたいな」

この辺に図

「「それだ」」
「で、制御はどうするのよ」
「TWE-liteモジュールというのを最近知ったんだけど、何か使えるものがないと思っていてね。PCからシリアル通信で制御信号を送って、子機のピン状態を制御できる」
「後々自動運転とかもできそうだ。動力は？」
「マブチ/田宮水中モーターをバラす」
「「いけそう」」

という感じでプロジェクトが発足。

## 「プロジェクトぷかぷか丸」概要

と、言うわけでこの計画を「プロジェクトぷかぷか丸」むとなんとなく命名、スタートしていくことになりました。
計画の中核を担うコバンザメ式のリモコン艦は、白鳥はが泳ぐ際、水面上は優雅に泳いでいるのに対して、水面下ではじたばたと頑張っているという様子に見習い、「じたばた丸」と命名。

1.プロジェクトの目的
 1.軍艦モデルを水上航行させて遊ぶプロジェクトです 1.完全潜水型のリモコン艦「じたばた丸」に、小加工(水密加工や浮力重量調整程度)を施したフルハル型の軍艦モデルを乗っけることで、あたかも軍艦モデルを操縦しているかのように動かせるのを第一目標とします
　1.TWE-liteモジュールにて無線コントロールをします。親機はPCとし、将来的なソフトウエア制御や複数人での
1.やらないこと
 1.軍艦モデルを作りこむ。スクラッチする

と、ざっくり目的を決めてプロジェクト開始です。General quaters!
 
# 技術試験一号艦

とにかくまずは最低限の機能を満たすモノを作ってみるのが一番です

## TWE-liteとは？

TWE-liteとはTOCOS wireless engine(東京コスモス電機株式会社)が製造販売している、無線チップです。Zigbee規格の通信チップを、TOCOSオリジナルのマイコンとソフトで使いやすくパッキングしたモノ、という雰囲気です。公式サイトでは、いろいろできることを謳っていますが、そのせいかややぼんやりとした、捉えどころの分からない製品という印象を受けてしまい、その点ではやや残念。
ZigBeeモジュールの仕様を特に気にせず使えることや、TOCOSのオリジナルソフトがマイコンに書き込んでありラジコン系の実装が簡単にできること、消費電力が低く間欠モードとボタン電池で年単位の稼働ができることをウリにしています。低速度通信を低消費電力で行う製品で、応用例としてはセンサー類を搭載して工場などの広い場所にばら撒いて使うセンサーネットワークが一番適しているようです。無線の到達距離は、付属の小さなアンテナで、見通し距離1km、密集地で100～200m程度が実用範囲とのこと。
いろいろできることを謳ってますが、今回は単なるラジコンを作るチップとして使います。

ラジコンを作る場合、TWE-liteに最初から書き込んであるTOCOSアプリがまさにそのままラジコンの機能を提供してくれます。詳しい説明は公式サイトに譲りますが、TWE-liteのデフォルトでは、親機と子機のピン状態を20ms程度のズレで同期します。デジタル入力ピンはデジタル出力へ、アナログ入力ピンはPWMとして出力されます。
今回は親機をPCとするため、TWE-liteシリーズ製品のUSBドングル"TOCOStick"を使い、ソフトから親機のピン状態を指定する形でいきます
http://tocos-wireless.com/jp/products/TWE-ZERO/App_Twelite/index.html

TOCOStickは専用のソフトがとりあえず用意されていて、それを使うことでざっくりとした制御ができます。が、TOCOStick自体がUSB-シリアル通信モジュールとTWE-liteがセットになったものでなので、自作のソフトで適当にシリアル通信すれば、PCやホストUSBを持つAndroidデバイスで制御できるようです。プロトコルも公式サイトのサンプルコードから読めるようです(http://tocos-wireless.com/jp/products/TWE-Lite-USB/windows.html)。今回はソフト開発を友人に頼んだことと、そっちの開発が進んでないことから、ここでは触れません。

ラジコンとなると個体管理が必要になりますが、TWE-liteではアプリケーションIDとチャンネルで個体識別ができます。チャンネルは、使用する電波帯域ですから今回のラジコン艦グループで1つ、一意に決めるのが良さそうです。アプリケーションIDは、子機に与えられる番号で親機からはこれを指定して送ること、それぞれ子機を区別できます。逆に親機が通信を受け取る場合、TOCOStickでは子機のIDが通知されるようです。アプリID、チャンネル回りの設定には、TWE-liteチップをPCにつないでシリアル通信のインタラクションモードで設定する必要があるとのことで、専用のライターTWE-liteRを買うのが早いようです。ということろまでは調べてますが、今回はこのあたりの個体管理までは検証できてません。
とりあえず、将来的な拡張にも耐えられるということが分かったあたりで、実際に船を作っていきます。

## ざっくりシステム仕様

まずはメインエンジンこと主電機を決めます。入手性と確実性から田宮製水中モーターをそのまま転用しましょう。これはかつてはマブチから出ていたキットで、単三または単四電池1本で動くシンプルなモーターライズキットです。ちゃんと舵にサーボを付ける方法もありでしたが、構造がシンプルな方ということで、2機モーターを横に並べそれぞれの出力を制御して、旋回を行うこととしました。まあ、戦車のキャタピラと同じ要領ですね。
モーターを決めたので、動力側電源が決まります。1.5Vですね。

これをTWE-liteから制御するために、モータードライバーICを調べます。TWE-liteはちょっと困ったことに、最大電圧が3.6V。ボタン電池やより小電力な電源を使う場合には便利なんでしょうが、電子部品は5Vで動作するように作られてるものが多いため、3V駆動となるとパーツを結構選びます。またモータードライバの出力側も同様で、田宮水中モーター1.5Vのような小電圧はこれまた選びます。
そんなわけで秋月電子の通販ページを、ぺらぺら見ているとよさそうなのがあるじゃないですか。()のちにこれがちょっと問題になりますが…

そしてじたばた丸の心臓部TWE-lite。3V電源ということで単三電池を2本積むことにしましょう。動力電源が1.5V1本で、電子系が3Vで2本というのはなんだかバランスがおかしいですが、まあ試作なんでいいや

船体はとりあえず水密が確実かつ安価なもの、ということで食品保存用のタッパーを転用しました。適当な百円均一で適当に用意します。
さあこれでざっくりモノができそうな感じがしてきました。…あれ？電子工作らしい部品が全然ないんだけど、大丈夫？

## 建造

## 試験チャンバーでの浮力試験

## 残り作業

じたばた丸は自身の船体を沈めて隠す必要があります。それを実現するために、水面ギリギリにフロートをつけ、それで何とか浮くように重しを乗せることにしました。フロートは工作用スチロール板を切り出汁、軍艦モデルを支える柱を兼ねるようにします。
浮力が多すぎる場合は、ウエイトを内外に取り付けて沈めます。ウエイトには、アマゾンで安かった鉄球(パチンコ用)と、鉛テープを使いました。

試して見ると浮力は相当余剰があるようで、電気系の2倍以上の鉄球を積むことになりましたが、まあいいでしょう。最後にじたばた丸全体をグレーで塗装し、軍艦モデルを作って(これが一番手間かかるとも言う)上に張り付けて完成。モデルは試作ということもあり、アマゾンで一番安く作りやすそうなアオシマの駆逐艦磯風(フルハル)としました。船底は水密にしておき浮力を生むようにしたかったのですが、難しかったためスチロールを詰めて同じく船体が水面上に出やすくしました。

## どう見ても宇宙駆逐艦

というわけで、試作一号艦ができました。建造時間は2人日程度。ペコポーン♪(艦これSE)


ってなんじゃこりゃあああ。うーん、機能と部品は間違ってないんだけど、タッパーがデカすぎて、当初のイメージからはかなりズレたものになりました。スタートレックのUSSエンタープライズ系の何かですねコレは。駆逐艦磯風は宇宙駆逐艦磯風になってしまいました。

## MUTU System

# 一号艦、公園じゃぶじゃぶ池海域に出撃す！

バケツ試験チャンバー内での動作確認を済ませたら、適度な広さの水辺に行って試運転をします。
気楽に使えて、そこそこ広く、じたばた丸の船体が擦らない程度の深さがあり、制御不能時にはサンダルとかでざぶざぶ歩いていけるような水辺…。そう、公園です。といっても、柵があったりするような池ではなくて、ちびっこの水遊び場として作られた「じゃぶじゃぶ池」がまさに最適でした。水深が20cm以下でそこそこ広く、流水があって水がきれいです。

# 二号艦への課題

試験航海からいろいろと成功と問題が発覚しました。

## じたばた丸のコンセプトは正しかった

池の底が明るい色だったり、船の直上から見た場合はともかくして、船体に対してじたばた丸自体はあまり目立たず、ちゃんと軍艦モデルが自力航行しているように見えました。これには驚きました。バケツ内での浮力調整のときには、透明なバケツでやっていたこともあってか、かなり間抜けな姿になるのではないか？と危惧していたのに、このコンセプトがちゃんと実用レベルだったことはとても重要な成功です。
特に水面が反射するような浅い角度や、水面が太陽光で光る逆光のシチュエーションではバッチリ隠れて最高にカッコイイ…。

## 推力は不足。電源強化が必要

電源1.5Vでは推力不足でした。じゃぶじゃぶ池は見ていてわからない程度に緩やかに流れているのですが、川上に向けて静止するのがやっとなほど推力が不足していました。
あとでデータシートを確認して気づいたのですが、モータードライバには内部抵抗が1Ω(0.5Ω～1.5Ω幅)で存在することから、想定より相当電圧が下がっていたようです。また、電源を単三電池1本1.5Vに対して、モーター2個を駆動するという設計だったのもマズイようです。電源強化が必要でした。
他にも、PWM出力ではデューティー比60%以上でないとモーターが回転開始しませんでした。電源の電圧アップでおそらく改善すると思いますが、TWE-liteの設定でPWM周波数の調整ができるとそれも影響するかもしれません。PWMによるモーター制御は、電圧変化によるモーター制御より、低速回転のレンジが広いといわれてますが、電圧不足ではそもそも立ち上がりが悪くなるのは仕方ないのかもしれません。
さらに調べて見ると、田宮水中モーターに使われているモーターの交換品のデータシートを、せんごくネットで見つけることができました。それによると定格でこのモーターは3Vを受け付けるようです。次の船体では3V前後の電源を用意して、出力向上とPWM制御精度向上を狙うこととします

## 直進安定性が低い

全然まっすぐ進みません。操作している間は、PWM出力で左100に対して、右96ぐらいでだいたい直進する感じでしたが、右を97にするとガッツリ左旋回を始めるし、右を95にすると実際の船なら面舵いっぱいといった雰囲気で右旋回をしてしまいます。
おそらく原因はいくつかあるようです。
まずは船体。真四角のタッパーをバカ正直に配置してるため、正面に当たった流水が左右に分かれる際、左右のモーターのわずかな出力差で左に流れるか右に流れるかが決まってしまうようです。やはりちゃんとした船体の用に三角形の切っ先にするなり、潜水艦のような滴涙型(ティアドロップ)にするのが良さそうです。
もう一つはモーター制御側。今回の単三乾電池1.5V1本に頼る電源は、モーター2系統を動かすには足りないようで、左右同時に動かした場合はモーター音がやや低くなりました。ということは、PWM制御で片方が止まっているとき、もう片方の動ているモーターは、2系統のモーターを動かすときより多くの出力を出せることになるでしょう。この対策には、モータドライバの直前にバイパスコンデンサを用意して、電源の安定化を図るのが良さそうです。

## モータードライバに逆転機能がない

これは完全にうっかりでした。注文時にちゃんと確認するべきでした
とはいえ、1.5Vで使えるモータードライバは他に見当たらなかったので仕方ありません。次では動力電源を1.5Vから3V前後に変更するので、モータードライバの選択で悩む必要はなくなりました。まっとうなモータードライバを選択して、TWE-liteのデジタル出力DIOの制御で逆回転できるようにします。

## コントロールソフトが暫定すぎる

今回とにかく動くことを目標にしたため、制御ソフトはTOCOS提供のWindowsアプリにしました。このアプリはとりあえずの検証をするには問題ありませんでしたが、ラジコン操作をするには不便です。操作の度に、スライダでPWM出力値を決めて、送信ボタンを押す必要がありました。
次はこの辺もちゃんと用意するようにしましょう。

# 二号艦
## 電装系改良
## 船体改良
# 俺たちの建造はこれからだ


## サンプル


テキストテキスト

`code`

**Bold**

[https://twitter.com/](https://twitter.com/)
